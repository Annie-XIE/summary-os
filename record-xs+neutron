When integrating neutron(lastest master branch code) with Xenserver 6.5, 
I met many problems which took me a lot of time struggling to solve. I'm 
not quite familiar with neutron, and also for the whole openstack project, 
I'm a new commer, only knows the basic and rough concepts.

I use devstack to install all components in one single host, and the host 
itself is a VM

Here some operation steps and problems I met:
1. My env using ML2 plugin with OVS as driver, for tenant network, I set
it to vlan. So in localrc file, I set these configurations
====================================================================
# Set the network name of the integration bridge
XEN_INTEGRATION_BRIDGE=${DEVSTACK_GATE_XS_INT_BR}

# Disable nova-networking, n-net
ENABLED_SERVICES+=,-n-net

# Enable neutron network (q-svc, q-agt, q-dhcp, q-l3, q-meta, q-domua)
ENABLED_SERVICES+=,q-svc,q-agt,q-dhcp,q-l3,q-meta,q-domua,neutron

# using ml2 plguin, set vlan
# disable tunneling as the OVS shipped with XenServer does notsupport it
# Use VLANs with ML2
# Disable security groups
Q_PLUGIN=ml2
ENABLE_TENANT_VLANS=True
ENABLE_TENANT_TUNNELS=False
Q_ML2_TENANT_NETWORK_TYPE=vlan
Q_USE_SECGROUP=False

# this part maybe change in different scenario
Q_AGENT=openvswitch
Q_ML2_PLUGIN_MECHANISM_DRIVERS=openvswitch
Q_ML2_PLUGIN_TYPE_DRIVERS=vlan

# I guess we should set ML2_VLAN_RANGES other than OVS_VLAN_RANGES, 
# since we use ml2 plugin
ML2_VLAN_RANGES="physnet1:1000:1024"
=========================================================

2. Bootig q-agt failed

It said "Bridge br-int for physical network physnet1 does not exist. 
Agent terminated!" in the log. It's quite confused, br-int is in DomU, 
xapi2 is the one in dom0, but why does q-agt got br-int other than xapi2?
Seems this command is send to the wrong OVS, it should sent to dom0's 
OVS, but actually was sent to domU's OVS.
Check with neutron code, and useful links bob gave, I found the root 
cause resides in the command execusion mode, current setting is daemon 
mode, but daemon mode cannot hook with dom0, 
(1) Set root_helper_daemon to empty in neutron/plugins/ml2/ml2_conf.ini, 
so it is command mode
(2) Add sudoer configurations in /etc/sudoers.d/neutron-rootwrap

But still fail, however with other errors in log "Failure: 
['XENAPI_PLUGIN_FAILURE', 'netwrap', '', '", 
For this problem, I grep neutron code and devstack code and found the root 
cause is there are some file folder changes but the devscript doesn't change, 
so netwrap script does not exist in dom0, it's easy to correct this. 
(1) copy netwrap to dom0 /etc/xapi.d/plugins

With these steps, q-agt can boot successfully, cheers!

3. vm cannot get IP from dhcp

I begin to launch instance and it all runs well, the instance is created
and started successfully, but when I try to login this instance, always 
failed, and from XenCenter's consolo, I found this instance doesn't get 
an IP address. Why?

Conclusion:
(1) Root cause: For q-agt, it will monitor OVS status and Port changes 
during its rpc_loop, but its default polling mechenism is minimized poll
(this is a configuration item in ml2_conf.ini), and for my environment it
seems it will never get the port changes, this means it cannot detect that 
there are ports created and to be bound. Then the new created VM cannot get 
its vif related port be set the correct tag. Thus, without a valid tag OVS 
will drop all the packages from this vif. Therefore, the VM cannot get its 
DHCP request broadcast message delivered to q-dhcp agent and of course it 
cannot get IPV4 address.
My current solution is set "minimize_polling = False" in q-agt's ml2_conf.ini file.

(2) There are advices from website that they recommond to use a formal image, 
I think the reason is, for some image, when booted, it will try to ask DHCP 
request from time to time until it get a IPV4 address. This can avoid the race 
condition that the port bind and the tag is not set ready when the VM finished 
the DHCP request. e.g. my cirros image will only ask for DHCP request three 
times when booted.

Questions to figure out: 
I still cannot understand, even with minimized_polling to be true, it should 
notice that there is new port added. Should go deep into code of this part.

TODO:
1. When unstack.sh and delete DevStackDomU, some bridges still exist in dom0, 
xapi1 is deleted, but xapi0 and xapi2 still exist

# ovs-vsctl list-br
xapi0
xapi2
xapi3
xapi4
xapi5
xenbr0
xenbr1


After expierence all these, I think take the whole picture of both nova and
neutron is very necessary, you should know the work flow clearly, then when
you meet problem, you will have idea about which part is suspicious one

And also, in my case, I use OVS, so make sure to read some material about OVS
and its mechanism, otherwise you will sometime don't know how to deal with these

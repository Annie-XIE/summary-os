# Debugging why VMs cannot get IP from DHCP agent with XenServer + Neutron

Deployment environment:
  XenServer 6.5
  OpenStack latest master code
  Neutron ML2 plugin, OVS driver, VLAN type

XenServer+Neutron do work years before, but the support for neutron break
when more and more changes made in neutron.
I began getting XenServer+Neutron back to work with previous blog
[openstack-networking-quantum-on-xenserver](http://blogs.citrix.com/2013/06/14/openstack-networking-quantum-on-xenserver-from-notworking-to-networking/)

There are some changes with DevStack script to let XenServer+Neutron be
installed and ran properly.

Below are some debugging process I made when new launched VMs cannot get IP
from DHCP agent.

Brief description on the steps of VM getting IP from DHCP:
When VMs are booting, they will try to send DHCP request broadcast message
within and the same domain and waiting for reply. If VMs cannot get IP address,
the straightforward we react is using tcpdump to check whether request messages
arrived at DHCP agent in DomU, see [this picture](https://github.com/Annie-XIE/summary-os/blob/master/flow-VM-to-DomU.png)

## dump traffic in DomU
execute "sudo ip netns", you probably get outputs like these

  qrouter-6fc387e3-12d5-45c4-8a0a-ad2b71c3910d
  qdhcp-beb4e93b-6000-44c0-8b1a-da79ecbd1769
  
Note: qdhcp-xxx is the namespace for DHCP agent

## check interface that DHCP agent uses for L3 traffic
execute "sudo ip netns exec qdhcp-beb4e93b-6000-44c0-8b1a-da79ecbd1769 ifconfig", you can see interface like tapxxxx

  tap27cc06a0-02 Link encap:Ethernet  HWaddr fa:16:3e:dd:92:da  
          inet addr:10.0.0.2  Bcast:10.0.0.255  Mask:255.255.255.0
          inet6 addr: fda6:db70:6ffa:0:f816:3eff:fedd:92da/64 Scope:Global
          inet6 addr: fe80::f816:3eff:fedd:92da/64 Scope:Link
          UP BROADCAST RUNNING  MTU:1500  Metric:1
          RX packets:65594 errors:0 dropped:0 overruns:0 frame:0
          TX packets:10 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:7215312 (7.2 MB)  TX bytes:836 (836.0 B)

## moniter traffic flow within tap27cc06a0-02


